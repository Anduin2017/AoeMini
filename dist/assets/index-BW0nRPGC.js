(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(o){if(o.ep)return;o.ep=!0;const i=t(o);fetch(o.href,i)}})();var k=(l=>(l.Player="player",l.Enemy="enemy",l))(k||{}),_=(l=>(l.Infantry="INFANTRY",l.Cavalry="CAVALRY",l.Archer="ARCHER",l.Siege="SIEGE",l.Melee="MELEE",l.Ranged="RANGED",l.Light="LIGHT",l.Heavy="HEAVY",l.Worker="WORKER",l))(_||{}),g=(l=>(l.Worker="worker",l.Spearman="spearman",l.ManAtArms="man_at_arms",l.Longbowman="longbowman",l))(g||{}),y=(l=>(l.TownCenter="towncenter",l.House="house",l.Barracks="barracks",l.ArcheryRange="archery_range",l.Blacksmith="blacksmith",l))(y||{});const u={TICK_RATE:100,MAX_TOTAL_POP:200,BASE_RANGE:5,INITIAL_RES:{food:200,wood:200,gold:100,stone:0},BASE_HP:2e3,INITIAL_POP_CAP:10,UNIT_SIZE_PERCENT:.8,BASE_WIDTH:4,PLAYER_BASE_POS:4,ENEMY_BASE_POS:96,COLORS:{PLAYER:"#3b82f6",ENEMY:"#ef4444",PLAYER_HP:"#22c55e",TEXT_FLOAT_DMG:"#fff",TEXT_FLOAT_BASE:"#f00"}};class O{constructor(e){this.totalWorkers=0,this.idleWorkers=0,this.buildings=[],this.constructions=[],this.units=[],this.baseHp=u.BASE_HP,this.popCap=u.INITIAL_POP_CAP,this.armyCount=0,this.hasTurret=!1,this.turretCooldown=0,this.techLevels={atk_m:0,def_m:0,atk_r:0,def_r:0},this.type=e,this.resources={...u.INITIAL_RES};const t=e===k.Player?6:7;this.workers={food:t,wood:0,gold:0,stone:0},this.totalWorkers=t,this.idleWorkers=0,this.hasTurret=!0,this.turretCooldown=0}get currentPop(){return this.totalWorkers+this.armyCount}}class N{constructor(e){this.game=e,this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.bgCanvas=document.getElementById("bgCanvas"),this.bgCtx=this.bgCanvas.getContext("2d"),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const e=document.getElementById("game-wrapper"),t=e.offsetWidth,s=e.offsetHeight;this.canvas.width=t,this.canvas.height=s,this.bgCanvas.width=t,this.bgCanvas.height=s,this.game.worldWidth=t}draw(){const e=this.canvas.width,t=this.canvas.height;this.ctx.clearRect(0,0,e,t),this.bgCtx.clearRect(0,0,e,t),this.bgCtx.strokeStyle="#333",this.bgCtx.lineWidth=2,this.bgCtx.beginPath(),this.bgCtx.moveTo(0,t/2-20),this.bgCtx.lineTo(e,t/2-20),this.bgCtx.stroke(),this.bgCtx.beginPath(),this.bgCtx.moveTo(0,t/2+20),this.bgCtx.lineTo(e,t/2+20),this.bgCtx.stroke(),this.drawBase(this.game.player,u.PLAYER_BASE_POS,u.COLORS.PLAYER),this.drawBase(this.game.enemy,u.ENEMY_BASE_POS,u.COLORS.ENEMY);const s=[...this.game.player.units,...this.game.enemy.units];s.sort((o,i)=>o.lane-i.lane);for(const o of s){const i=o.pos/100*e,n=o.lane===1?t/2-20:t/2+20;if(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.ellipse(i,n-2,6,3,0,0,Math.PI*2),this.ctx.fill(),this.ctx.fillStyle=o.owner===k.Player?u.COLORS.PLAYER:u.COLORS.ENEMY,o.type===g.ManAtArms?this.ctx.fillRect(i-8,n-20,16,20):o.type===g.Spearman?(this.ctx.beginPath(),this.ctx.arc(i,n-8,8,0,Math.PI*2),this.ctx.fill()):o.type===g.Longbowman?(this.ctx.fillStyle=o.owner===k.Player?"#8b5cf6":"#a855f7",this.ctx.beginPath(),this.ctx.moveTo(i,n-20),this.ctx.lineTo(i-6,n),this.ctx.lineTo(i+6,n),this.ctx.fill()):this.ctx.fillRect(i-5,n-15,10,15),this.ctx.fillStyle="#ccc",o.type===g.Spearman?this.ctx.fillRect(o.owner===k.Player?i+2:i-12,n-10,10,2):o.type!==g.Longbowman&&this.ctx.fillRect(o.owner===k.Player?i+5:i-5,n-15,8,2),o.attackAnimTimer>0){this.ctx.strokeStyle="#ffff00",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(o.owner===k.Player?i+5:i-5,n-15);let c=0;if(o.targetId==="base"){const a=o.owner===k.Player?u.ENEMY_BASE_POS:u.PLAYER_BASE_POS,p=o.owner===k.Player?1:-1;c=(a-p*u.BASE_WIDTH/2)/100*e}else c=o.owner===k.Player?i+30:i-30;this.ctx.lineTo(c,n-10),this.ctx.stroke()}const r=o.hp/o.maxHp;this.ctx.fillStyle="red",this.ctx.fillRect(i-8,n-28,16,3),this.ctx.fillStyle=u.COLORS.PLAYER_HP,this.ctx.fillRect(i-8,n-28,16*r,3)}this.game.turretShots.forEach(o=>{this.ctx.strokeStyle=o.color,this.ctx.lineWidth=3,this.ctx.beginPath(),this.ctx.moveTo(o.start/100*e,t/2-30),this.ctx.lineTo(o.end/100*e,t/2),this.ctx.stroke(),this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(o.end/100*e,t/2,5,0,Math.PI*2),this.ctx.fill()})}drawBase(e,t,s){const o=this.canvas.width,i=this.canvas.height,n=t/100*o,r=u.BASE_WIDTH/100*o/2,c=i/2-40,a=i/2+40;this.ctx.fillStyle=s,this.ctx.fillRect(n-r,c,r*2,80);const p=r*.4;this.ctx.fillRect(n-r,c-10,p,10),this.ctx.fillRect(n+r-p,c-10,p,10),this.ctx.fillRect(n-p/2,c-10,p,10),this.ctx.strokeStyle="#1e293b",this.ctx.lineWidth=3,this.ctx.strokeRect(n-r,c,r*2,80),this.ctx.fillStyle="#0f172a";const d=r*.8,m=50;this.ctx.beginPath(),this.ctx.moveTo(n-d/2,a),this.ctx.lineTo(n-d/2,a-m+d/2),this.ctx.arc(n,a-m+d/2,d/2,Math.PI,0),this.ctx.lineTo(n+d/2,a),this.ctx.fill(),this.ctx.strokeStyle="#334155",this.ctx.lineWidth=2,this.ctx.stroke();const b=r*2.4,h=6,f=c-25;this.ctx.fillStyle="rgba(0,0,0,0.7)",this.ctx.fillRect(n-b/2,f,b,h);const E=Math.max(0,e.baseHp/u.BASE_HP);this.ctx.fillStyle=u.COLORS.PLAYER_HP,this.ctx.fillRect(n-b/2,f,b*E,h),this.ctx.strokeStyle="rgba(255,255,255,0.3)",this.ctx.lineWidth=1,this.ctx.strokeRect(n-b/2,f,b,h),e.hasTurret&&(this.ctx.fillStyle="#64748b",this.ctx.beginPath(),this.ctx.moveTo(n-15,c-10),this.ctx.lineTo(n+15,c-10),this.ctx.lineTo(n,c-25),this.ctx.fill())}}class q{constructor(e){this.isRunning=!1,this.game=e}start(){if(this.isRunning)return;this.isRunning=!0,this.intervalId=setInterval(()=>{this.game.update()},u.TICK_RATE);const e=()=>{this.isRunning&&(this.game.renderer.draw(),requestAnimationFrame(e))};requestAnimationFrame(e)}stop(){this.isRunning=!1,clearInterval(this.intervalId)}}class S{static spawnFloater(e,t,s){const o=document.getElementById("game-wrapper");if(!o)return;const i=document.createElement("div");i.className="floater";const n=o.getBoundingClientRect();i.style.left=e/100*n.width+"px",i.style.top=n.height/2-20+"px",i.style.color=s,i.innerText=t,o.appendChild(i),setTimeout(()=>i.remove(),1e3)}static showToast(e,t="#ef4444"){const s=document.getElementById("toast-container");if(!s)return;const o=document.createElement("div");o.className="toast text-white px-4 py-2 rounded shadow-lg font-bold",o.style.background=t,o.innerText=e,s.appendChild(o),setTimeout(()=>o.remove(),2e3)}}const x={[g.Worker]:{cost:{food:50},time:200,hp:10,damage:0,def_m:0,def_r:0,range:1,speed:0,tags:[_.Worker],label:"æ‘æ°‘",lane:0},[g.Spearman]:{cost:{food:60,wood:20},time:150,hp:90,damage:8,def_m:0,def_r:0,range:u.BASE_RANGE,speed:1.25,tags:[_.Infantry,_.Melee,_.Light],label:"é•¿æªå…µ",lane:0,attackType:"melee",cooldown:19},[g.ManAtArms]:{cost:{food:100,gold:20},time:150,hp:140,damage:11,def_m:2,def_r:3,range:u.BASE_RANGE*.75,speed:1.125,tags:[_.Infantry,_.Melee,_.Heavy],label:"æ­¦å£«",lane:0,attackType:"melee",cooldown:14},[g.Longbowman]:{cost:{food:40,wood:50},time:150,hp:70,damage:6,def_m:0,def_r:0,range:u.BASE_RANGE*3,speed:1.125,tags:[_.Infantry,_.Ranged,_.Light],label:"é•¿å¼“å…µ",lane:1,widthScale:.5,attackType:"ranged",cooldown:16}},L={house:{cost:{wood:50},time:150,label:"æˆ¿å±‹",icon:"ğŸ ",pop:10,desc:"æä¾› 10 äººå£ä¸Šé™"},barracks:{cost:{wood:150},time:300,label:"å…µè¥",icon:"âš”ï¸",desc:"è®­ç»ƒæ­¥å…µå•ä½"},archery_range:{cost:{wood:150},time:300,label:"é¶åœº",icon:"ğŸ¹",desc:"è®­ç»ƒè¿œç¨‹å•ä½"},towncenter:{cost:{wood:400,stone:350},time:1200,label:"åŸºåœ°",icon:"ğŸ›ï¸",pop:10,desc:"èµ„æºä¸­å¿ƒä¸æ‘æ°‘ç”Ÿäº§"},blacksmith:{cost:{wood:150},time:250,label:"é“åŒ é“º",icon:"âš’ï¸",desc:"å‡çº§æ”»å‡»ä¸é˜²å¾¡ç§‘æŠ€"}};class D{constructor(e){this.game=e}update(){this.processFaction(this.game.player,this.game.enemy,1),this.processFaction(this.game.enemy,this.game.player,-1),this.cleanupDead(),this.processTurrets()}processFaction(e,t,s){const o=[...e.units],i=s===1?this.game.playerStance:this.game.enemyStance;i==="attack"?o.sort((r,c)=>s===1?c.pos-r.pos:r.pos-c.pos):o.sort((r,c)=>s===1?r.pos-c.pos:c.pos-r.pos);const n=[...t.units];o.forEach((r,c)=>{if(this.handleCombat(r,n,t,s),!(r.stopOnAttack&&r.state==="attack")){const a=o.filter(d=>d.lane===r.lane),p=a.findIndex(d=>d.id===r.id);this.handleMovement(r,a,n,p,s,i)}})}handleCombat(e,t,s,o){e.attackAnimTimer>0&&e.attackAnimTimer--,e.attackCooldown>0&&e.attackCooldown--;const i=x[e.type],n=i.attackType||"melee",r=n==="melee",a=(o===1?u.ENEMY_BASE_POS:u.PLAYER_BASE_POS)-o*u.BASE_WIDTH/2;let p=t.filter(m=>!(Math.abs(e.pos-m.pos)>e.range||r&&(o===1&&e.pos<a&&m.pos>a||o===-1&&e.pos>a&&m.pos<a))),d=null;if(p.length>0?(p.sort((m,b)=>Math.abs(e.pos-m.pos)-Math.abs(e.pos-b.pos)),d=p[0]):Math.abs(e.pos-a)<=e.range&&(d="base"),d){if(e.state="attack",e.targetId=d==="base"?"base":d.id,e.attackCooldown<=0){e.attackCooldown=i.cooldown||15,e.attackAnimTimer=3;let m=e.damage;if(d!=="base"&&(m+=e.getBonusDamage(d.tags)),d==="base"){const h=Math.max(1,m-2);s.baseHp-=h,S.spawnFloater(a,`-${h}`,u.COLORS.TEXT_FLOAT_BASE)}else{const b=n==="ranged"?d.def_r:d.def_m,h=Math.max(1,m-b);d.hp-=h,S.spawnFloater(d.pos,`-${h}`,u.COLORS.TEXT_FLOAT_DMG)}}return!0}else return e.state="move",!1}handleMovement(e,t,s,o,i,n){const r=e.owner===k.Player?u.PLAYER_BASE_POS:u.ENEMY_BASE_POS,c=r+i*u.BASE_WIDTH/2;e.isDeployed||(i===1&&e.pos>c+e.width/2||i===-1&&e.pos<c-e.width/2)&&(e.isDeployed=!0);let a=e.pos;const p=e.speed*i;if(n==="attack"){if(a+=p,o>0){const f=t[o-1].pos-i*e.width;(i===1?a>f:a<f)&&(a=f)}const d=s.filter(h=>h.lane===e.lane);if(d.length>0){const f=d.sort((E,v)=>Math.abs(e.pos-E.pos)-Math.abs(e.pos-v.pos))[0].pos-i*(e.width+.1);(i===1?a>f:a<f)&&(a=f)}const b=(i===1?u.ENEMY_BASE_POS:u.PLAYER_BASE_POS)-i*(u.BASE_WIDTH/2+e.width/2);i===1?a>b&&(a=b):a<b&&(a=b)}else if(n==="defend"){a-=p;const d=r+i*(u.BASE_WIDTH/2+e.width/2);if(i===1){let m=e.isDeployed?d:r;o>0&&(m=Math.max(m,t[o-1].pos+e.width)),a<m&&(a=m)}else{let m=e.isDeployed?d:r;o>0&&(m=Math.min(m,t[o-1].pos-e.width)),a>m&&(a=m)}}e.pos=a}cleanupDead(){[this.game.player,this.game.enemy].forEach(e=>{e.units.filter(s=>s.hp<=0).forEach(s=>{s.tags.includes(_.Worker)?(e.totalWorkers--,e.workers.food--,e.workers.food<0&&(e.workers.food=0)):e.armyCount--}),e.units=e.units.filter(s=>s.hp>0)}),this.game.player.baseHp<=0?this.game.endGame(!1):this.game.enemy.baseHp<=0&&this.game.endGame(!0)}processTurrets(){[this.game.player,this.game.enemy].forEach(e=>{if(!e.hasTurret)return;if(e.turretCooldown>0){e.turretCooldown--;return}const t=e===this.game.player?this.game.enemy.units:this.game.player.units,s=e===this.game.player?u.PLAYER_BASE_POS:u.ENEMY_BASE_POS,o=u.BASE_RANGE*2,i=t.filter(n=>Math.abs(n.pos-s)<=o);if(i.length>0){e.turretCooldown=8;const n=Math.min(i.length,3);for(let r=0;r<n;r++){const c=i[Math.floor(Math.random()*i.length)],p=Math.max(1,12-c.def_r);c.hp-=p,this.game.turretShots.push({start:s,end:c.pos,color:e===this.game.player?"#60a5fa":"#f87171"}),S.spawnFloater(c.pos,`-${p.toFixed(1)}`,"#f0f")}}})}}const I={tech_atk_m_1:{cost:{food:50,gold:125},time:600,label:"è¿‘æˆ˜æ”»å‡» I",icon:"âš”ï¸",level:1,type:"atk_m",description:"è¿‘æˆ˜å•ä½æ”»å‡» +1"},tech_atk_m_2:{cost:{food:100,gold:250},time:600,label:"è¿‘æˆ˜æ”»å‡» II",icon:"âš”ï¸",level:2,type:"atk_m",description:"è¿‘æˆ˜å•ä½æ”»å‡» +1"},tech_atk_m_3:{cost:{food:150,gold:300},time:600,label:"è¿‘æˆ˜æ”»å‡» III",icon:"âš”ï¸",level:3,type:"atk_m",description:"è¿‘æˆ˜å•ä½æ”»å‡» +1"},tech_def_m_1:{cost:{food:50,gold:125},time:600,label:"è¿‘æˆ˜é˜²å¾¡ I",icon:"ğŸ›¡ï¸",level:1,type:"def_m",description:"è¿‘æˆ˜å•ä½é˜²å¾¡ +1"},tech_def_m_2:{cost:{food:100,gold:250},time:600,label:"è¿‘æˆ˜é˜²å¾¡ II",icon:"ğŸ›¡ï¸",level:2,type:"def_m",description:"è¿‘æˆ˜å•ä½é˜²å¾¡ +1"},tech_def_m_3:{cost:{food:150,gold:300},time:600,label:"è¿‘æˆ˜é˜²å¾¡ III",icon:"ğŸ›¡ï¸",level:3,type:"def_m",description:"è¿‘æˆ˜å•ä½é˜²å¾¡ +1"},tech_atk_r_1:{cost:{wood:50,gold:125},time:600,label:"è¿œç¨‹æ”»å‡» I",icon:"ğŸ¹",level:1,type:"atk_r",description:"è¿œç¨‹å•ä½æ”»å‡» +1"},tech_atk_r_2:{cost:{wood:100,gold:250},time:600,label:"è¿œç¨‹æ”»å‡» II",icon:"ğŸ¹",level:2,type:"atk_r",description:"è¿œç¨‹å•ä½æ”»å‡» +1"},tech_atk_r_3:{cost:{wood:150,gold:300},time:600,label:"è¿œç¨‹æ”»å‡» III",icon:"ğŸ¹",level:3,type:"atk_r",description:"è¿œç¨‹å•ä½æ”»å‡» +1"},tech_def_r_1:{cost:{wood:50,gold:125},time:600,label:"è¿œç¨‹é˜²å¾¡ I",icon:"ğŸ¯",level:1,type:"def_r",description:"è¿œç¨‹å•ä½é˜²å¾¡ +1"},tech_def_r_2:{cost:{wood:100,gold:250},time:600,label:"è¿œç¨‹é˜²å¾¡ II",icon:"ğŸ¯",level:2,type:"def_r",description:"è¿œç¨‹å•ä½é˜²å¾¡ +1"},tech_def_r_3:{cost:{wood:150,gold:300},time:600,label:"è¿œç¨‹é˜²å¾¡ III",icon:"ğŸ¯",level:3,type:"def_r",description:"è¿œç¨‹å•ä½é˜²å¾¡ +1"}};class W{constructor(e,t,s,o){this.width=0,this.hp=0,this.maxHp=0,this.id=e,this.type=t,this.owner=s,this.pos=o}get isAlive(){return this.hp>0}}class M extends W{constructor(e,t,s,o){super(e,t,s,o),this.tags=[],this.damage=0,this.def_m=0,this.def_r=0,this.range=u.BASE_RANGE,this.speed=0,this.state="move",this.targetId=null,this.lane=0,this.attackCooldown=0,this.attackAnimTimer=0,this.stopOnAttack=!1,this.isDeployed=!1}getBonusDamage(e){return 0}applyConfig(e){this.hp=e.hp,this.maxHp=e.hp,this.damage=e.damage,this.def_m=e.def_m,this.def_r=e.def_r,this.range=e.range,this.speed=e.speed/(1e3/u.TICK_RATE),this.tags=[...e.tags],this.lane=e.lane,this.width=u.UNIT_SIZE_PERCENT*(e.widthScale||1),this.attackCooldown=Math.floor(Math.random()*10)}}class Y extends M{constructor(e,t,s){super(e,g.Spearman,t,s),this.applyConfig(x[g.Spearman])}getBonusDamage(e){return e.includes(_.Cavalry)?8:0}}class F extends M{constructor(e,t,s){super(e,g.ManAtArms,t,s),this.applyConfig(x[g.ManAtArms])}}class G extends M{constructor(e,t,s){super(e,g.Longbowman,t,s),this.applyConfig(x[g.Longbowman]),this.stopOnAttack=!0}}class A extends W{constructor(e,t,s){super(e,t,s,s===k.Player?0:100),this.queue=[]}enqueue(e){return this.queue.length>=5?!1:(this.queue.push(e),!0)}getStatusText(){if(this.queue.length===0)return"ç©ºé—²";const e=this.queue[0];return e.ticksLeft<=.5&&e.ticksLeft>0?"âš ï¸ ç”Ÿäº§é˜»å¡":`ç”Ÿäº§ä¸­ ${Math.floor((1-e.ticksLeft/e.totalTicks)*100)}%`}getMenuOptions(e){return[]}get isGroupable(){return!1}}class U extends A{constructor(e,t){super(e,y.House,t)}get isGroupable(){return!0}getMenuOptions(){return[]}}class B extends A{constructor(e,t){super(e,y.TownCenter,t)}getMenuOptions(e){const t=[],s=x[g.Worker];return t.push({id:g.Worker,icon:"ğŸ‘·",label:s.label,cost:s.cost,time:s.time,type:"unit",desc:"é‡‡é›†èµ„æº"}),t}hasTechInQueue(e,t){return e.buildings.some(s=>s.queue.some(o=>o.type===t))}}class $ extends A{constructor(e,t){super(e,y.Barracks,t)}getMenuOptions(){return[g.Spearman,g.ManAtArms].map(t=>{const s=x[t];return{id:t,icon:"âš”ï¸",label:s.label,cost:s.cost,time:s.time,type:"unit",desc:s.label}})}}class X extends A{constructor(e,t){super(e,y.ArcheryRange,t)}getMenuOptions(){const e=x[g.Longbowman];return[{id:g.Longbowman,icon:"ğŸ¹",label:e.label,cost:e.cost,time:e.time,type:"unit",desc:"è¿œç¨‹è¾“å‡º"}]}}class Q extends A{constructor(e,t){super(e,y.Blacksmith,t)}getMenuOptions(e){const t=[];return["atk_m","def_m","atk_r","def_r"].forEach(s=>{const o=e.techLevels[s];if(o<3){const i=o+1,n=`tech_${s}_${i}`,r=I[n],c=e.buildings.some(a=>a.queue.some(p=>p.type===n));r&&!c&&t.push({id:n,icon:r.icon,label:r.label,cost:r.cost,time:r.time,type:"tech",desc:r.description})}}),t}}class V{constructor(e){this.game=e}update(){this.game.tickCount%10===0&&(this.gather(this.game.player),this.gather(this.game.enemy)),this.processQueues(this.game.player),this.processQueues(this.game.enemy),this.processConstructions(this.game.player),this.processConstructions(this.game.enemy)}gather(e){e.resources.food+=e.workers.food*.6,e.resources.wood+=e.workers.wood*.6,e.resources.gold+=e.workers.gold*.6,e.resources.stone+=e.workers.stone*.6}processQueues(e){e.buildings.forEach(t=>{if(t.queue.length>0){const s=t.queue[0];if(e.type===k.Player&&this.game.isInstantBuild?s.ticksLeft=0:s.ticksLeft>0&&s.ticksLeft--,s.ticksLeft<=0){let o=!1;const i=!s.type.startsWith("tech_");if(i&&e.type===k.Player&&e.currentPop>=e.popCap&&(o=!0),!o&&i&&s.type!==g.Worker){const n=e.type===k.Player?this.game.baseWidthPct:100-this.game.baseWidthPct,r=1;[...this.game.player.units,...this.game.enemy.units].some(p=>Math.abs(p.pos-n)<p.width/2+r/2)&&(o=!0)}o?s.ticksLeft=.1:(this.resolveProduction(e,s.type),t.queue.shift())}}})}resolveProduction(e,t){if(t.startsWith("tech_")){const n=I[t];n&&n.type&&n.level&&(e.techLevels[n.type]=n.level,e.units.forEach(r=>{this.applySingleTechEffect(r,n.type,1)}),e.type===k.Player&&S.showToast(`${n.label} ç ”å‘å®Œæˆ`,"#8b5cf6"));return}if(t===g.Worker){e.totalWorkers++,e.idleWorkers++;return}const s=e.type===k.Player?u.PLAYER_BASE_POS:u.ENEMY_BASE_POS;let o;const i=C.nextId();switch(t){case g.Spearman:o=new Y(i,e.type,s);break;case g.ManAtArms:o=new F(i,e.type,s);break;case g.Longbowman:o=new G(i,e.type,s);break}o&&(this.applyAllTechsToNewUnit(o,e),e.armyCount++,e.units.push(o))}applySingleTechEffect(e,t,s){const i=x[e.type].attackType||"melee";t==="atk_m"&&i==="melee"&&(e.damage+=s),t==="atk_r"&&i==="ranged"&&(e.damage+=s),t==="def_m"&&(e.def_m+=s),t==="def_r"&&(e.def_r+=s)}applyAllTechsToNewUnit(e,t){t.techLevels.atk_m>0&&this.applySingleTechEffect(e,"atk_m",t.techLevels.atk_m),t.techLevels.def_m>0&&this.applySingleTechEffect(e,"def_m",t.techLevels.def_m),t.techLevels.atk_r>0&&this.applySingleTechEffect(e,"atk_r",t.techLevels.atk_r),t.techLevels.def_r>0&&this.applySingleTechEffect(e,"def_r",t.techLevels.def_r)}processConstructions(e){const t=[];e.constructions.forEach(s=>{if(e.type===k.Player&&this.game.isInstantBuild?s.ticksLeft=0:s.ticksLeft>0&&s.ticksLeft--,s.ticksLeft<=0){let o;switch(s.type){case y.House:o=new U(s.id,e.type);break;case y.Barracks:o=new $(s.id,e.type);break;case y.ArcheryRange:o=new X(s.id,e.type);break;case y.TownCenter:o=new B(s.id,e.type);break;case y.Blacksmith:o=new Q(s.id,e.type);break;default:o=new $(s.id,e.type);break}e.buildings.push(o);const i=L[s.type];i&&i.pop&&(e.popCap+=i.pop,e.popCap>u.MAX_TOTAL_POP&&(e.popCap=u.MAX_TOTAL_POP)),e.type===k.Player&&S.showToast(`${i.label} å»ºé€ å®Œæˆ`,"#22c55e")}else t.push(s)}),e.constructions=t}}class K{constructor(e){this.game=e}update(){if(this.game.tickCount%10!==0)return;const e=this.game.enemy,t=this.game.player;e.idleWorkers=e.totalWorkers,e.workers={food:0,wood:0,gold:0,stone:0};const s=[{type:"food",amount:e.resources.food},{type:"wood",amount:e.resources.wood},{type:"gold",amount:e.resources.gold}];s.sort((h,f)=>h.amount-f.amount);let o=s[0].type;e.resources.food<50&&(o="food"),e.workers[o]=e.idleWorkers,e.idleWorkers=0;const i=e.units,n=t.units;let r=100;i.length>0&&(r=Math.min(...i.map(h=>h.pos)));let c=0;n.length>0&&(c=Math.max(...n.map(h=>h.pos)));const a=r-c,p=(c+r)/2;let d=!1;e.buildings.forEach(h=>{h.queue.length>0&&h.queue[0].ticksLeft<=.2&&(d=!0)}),d?this.game.enemyStance="attack":i.length>n.length*1.2||i.length>15?this.game.enemyStance="attack":a<30&&p>65?this.game.enemyStance="defend":this.game.enemyStance="attack",e.popCap-e.currentPop<3&&e.popCap<u.MAX_TOTAL_POP&&(e.constructions.some(f=>f.type===y.House)||this.tryBuild(e,y.House));let m=!1;const b=e.buildings.find(h=>h.type===y.Blacksmith);if(b&&b.queue.length===0){let h=null;if(e.techLevels.atk_m<3?h=`tech_atk_m_${e.techLevels.atk_m+1}`:e.techLevels.def_m<3&&(h=`tech_def_m_${e.techLevels.def_m+1}`),h&&I[h]){const f=I[h].cost;(e.armyCount>8||e.resources.gold>300)&&(this.canAfford(e,f)?(this.payCost(e,f),b.enqueue({type:h,ticksLeft:I[h].time,totalTicks:I[h].time})):m=!0)}}if(!m){let h=0;e.buildings.forEach(v=>v.queue.forEach(w=>{w.type===g.Worker&&h++})),e.totalWorkers+h<60&&e.buildings.filter(w=>w.type===y.TownCenter).forEach(w=>{w.queue.length<5&&this.tryQueueUnit(e,w,g.Worker)});const f=v=>e.buildings.filter(w=>w.type===v).length+e.constructions.filter(w=>w.type===v).length;let E=null;f(y.Barracks)<1?E=y.Barracks:f(y.ArcheryRange)<1?E=y.ArcheryRange:f(y.Blacksmith)<1?E=y.Blacksmith:f(y.Barracks)<4&&e.resources.wood>400&&(E=y.Barracks),E&&this.tryBuild(e,E),e.buildings.forEach(v=>{v.queue.length<5&&(v.type===y.Barracks?e.units.filter(H=>H.type===g.Spearman).length>5&&e.resources.gold>50?this.tryQueueUnit(e,v,g.ManAtArms):this.tryQueueUnit(e,v,g.Spearman):v.type===y.ArcheryRange&&this.tryQueueUnit(e,v,g.Longbowman))})}}canAfford(e,t){return e.resources.food>=(t.food||0)&&e.resources.wood>=(t.wood||0)&&e.resources.gold>=(t.gold||0)&&e.resources.stone>=(t.stone||0)}payCost(e,t){e.resources.food-=t.food||0,e.resources.wood-=t.wood||0,e.resources.gold-=t.gold||0,e.resources.stone-=t.stone||0}tryQueueUnit(e,t,s){const o=x[s].cost,i=x[s].time;if(this.canAfford(e,o)){if(s!==g.Worker&&e.currentPop>=e.popCap)return;this.payCost(e,o),t.enqueue({type:s,ticksLeft:i,totalTicks:i})}}tryBuild(e,t){if(t!==y.House){if(e.constructions.some(o=>o.type===t))return}else if(e.constructions.some(o=>o.type===y.House))return;const s=L[t];this.canAfford(e,s.cost)&&(this.payCost(e,s.cost),e.constructions.push({id:Math.random(),type:t,ticksLeft:s.time,totalTicks:s.time}))}}const T=class T{constructor(e){this.buildBtn=null,this.game=e,this.dockEl=document.getElementById("dock"),this.initStaticDock()}initStaticDock(){this.dockEl.innerHTML="";const e=document.createElement("div");e.className="dock-icon build-icon",e.id="dock-btn-build",e.innerHTML="ğŸ”¨",this.dockEl.appendChild(e),this.buildBtn=e}render(e,t){const s=this.game.player,o=new Map,i=[];s.buildings.forEach(a=>{a.isGroupable?i.push(a):o.set(a.id,{id:a.id,type:"building",entity:a,origin:a,queue:a.queue,isConstruction:!1,sortType:a.type})}),i.length>0&&o.set("group-house",{id:"group-house",type:"group",entity:i,icon:"ğŸ ",sortType:y.House}),s.constructions.forEach(a=>{o.set(`const-${a.id}`,{id:`const-${a.id}`,type:"construction",entity:a,origin:a,isConstruction:!0,ticksLeft:a.ticksLeft,totalTicks:a.totalTicks,sortType:a.type})});const n=Array.from(o.values()).sort((a,p)=>{const d=T.SORT_ORDER[a.sortType]||99,m=T.SORT_ORDER[p.sortType]||99;return d!==m?d-m:a.isConstruction!==p.isConstruction?a.isConstruction?1:-1:a.id>p.id?1:-1}),r=new Set(["dock-btn-build"]);n.forEach(a=>r.add(`dock-item-${a.id}`)),Array.from(this.dockEl.children).forEach(a=>{r.has(a.id)||this.dockEl.removeChild(a)});let c=0;n.forEach(a=>{const p=`dock-item-${a.id}`;let d=document.getElementById(p);if(d){const m=this.dockEl.children[c];m!==d&&this.dockEl.insertBefore(d,m||null)}else{d=this.createIconDom(p,a),d.onclick=()=>t(a.id,a);const m=this.dockEl.children[c]||null;this.dockEl.insertBefore(d,m)}this.updateIconVisuals(d,a),e===a.id?d.classList.add("active"):d.classList.remove("active"),c++}),this.buildBtn&&(this.dockEl.lastElementChild!==this.buildBtn&&this.dockEl.appendChild(this.buildBtn),this.buildBtn.onclick=()=>t("build_menu",{type:"menu"}),e==="build_menu"?this.buildBtn.classList.add("active"):this.buildBtn.classList.remove("active"))}createIconDom(e,t){const s=document.createElement("div");return s.id=e,s.className="dock-icon",s.innerHTML=`
            <div class="icon-content">${this.getIconEmoji(t)}</div>
            <div class="icon-progress-bg" style="display:none"><div class="icon-progress-fill"></div></div>
            <div class="icon-badge" style="display:none"></div>
            <div class="const-overlay" style="display:none"></div>
        `,s}getIconEmoji(e){var t;return e.type==="group"?e.icon:((t=L[e.entity.type])==null?void 0:t.icon)||"?"}updateIconVisuals(e,t){const s=e.querySelector(".icon-progress-bg"),o=e.querySelector(".icon-progress-fill"),i=e.querySelector(".icon-badge"),n=e.querySelector(".const-overlay");if(t.type==="construction"){e.classList.add("constructing"),s.style.display="block";const r=Math.floor(100-t.ticksLeft/t.totalTicks*100);o.style.width=r+"%",o.style.backgroundColor="#eab308",n&&(n.style.display="flex",n.innerText=`${r}%`),i.style.display="none",e.style.pointerEvents="none"}else if(e.style.pointerEvents="auto",e.classList.remove("constructing"),n&&(n.style.display="none"),t.type==="group")s.style.display="none",i.style.display="flex",i.style.backgroundColor="#f59e0b",i.innerText=t.entity.length.toString();else{const r=t.origin;if(r.queue.length>0){s.style.display="block";const c=r.queue[0],a=100-c.ticksLeft/c.totalTicks*100;o.style.width=a+"%",c.ticksLeft<=.2?o.style.backgroundColor="#ef4444":I[c.type]||c.type==="turret_tech"?o.style.backgroundColor="#22c55e":o.style.backgroundColor="#3b82f6",i.style.display="flex",i.style.backgroundColor="#ef4444",i.innerText=r.queue.length.toString()}else s.style.display="none",i.style.display="none"}}};T.SORT_ORDER={[y.TownCenter]:1,[y.Barracks]:2,[y.ArcheryRange]:3,[y.Blacksmith]:4,[y.House]:5};let P=T;class z{constructor(e){this.game=e,this.container=document.getElementById("popover-container")}hide(){this.container.style.display="none"}render(e,t){if(this.container.style.display="flex",this.setPosition(t),e==="build_menu")this.renderBuildMenu();else if(e.startsWith("group")){const s=this.game.player.buildings.filter(o=>o.isGroupable);this.renderGroupMenu(s)}else{const s=this.game.player.buildings.find(o=>o.id===e);s&&this.renderBuildingMenu(s)}this.updateStatus(e)}updateStatus(e){const t=this.game.player;if(this.container.querySelectorAll(".menu-btn").forEach(s=>{if(s.dataset.costWood!==void 0){const o=parseInt(s.dataset.costFood||"0"),i=parseInt(s.dataset.costWood||"0"),n=parseInt(s.dataset.costGold||"0"),r=parseInt(s.dataset.costStone||"0");t.resources.food>=o&&t.resources.wood>=i&&t.resources.gold>=n&&t.resources.stone>=r?(s.style.opacity="1",s.style.pointerEvents="auto"):(s.style.opacity="0.5",s.style.pointerEvents="none")}}),e!=="build_menu"&&!e.startsWith("group")){const s=t.buildings.find(o=>o.id===e);if(s){const o=document.getElementById("popover-status-text");if(o)if(s.queue.length>0){const n=s.queue[0],r=Math.floor((1-n.ticksLeft/n.totalTicks)*100),c=I[n.type]||n.type==="turret_tech";n.ticksLeft<=.2?(o.innerText="âš ï¸ ç”Ÿäº§é˜»å¡",o.className="text-xs text-center mb-2 font-bold text-red-500"):(o.innerText=`${c?"ç ”å‘ä¸­":"ç”Ÿäº§ä¸­"} ${r}%`,o.className=`text-xs text-center mb-2 font-bold ${c?"text-green-500":"text-blue-400"}`)}else o.innerText="ç©ºé—²",o.className="text-xs text-center mb-2 font-bold text-gray-500";const i=document.getElementById("popover-queue-info");i&&(i.innerText=`é˜Ÿåˆ—: ${s.queue.length} / 5`)}}}setPosition(e){const t=document.getElementById(e);if(t){const s=t.getBoundingClientRect(),o=s.left+s.width/2;this.container.style.left=`${o}px`}}renderGroupMenu(e){const t=L.house.desc;this.container.innerHTML=`
            <div class="popover-title">æˆ¿å±‹ç¾¤ (${e.length})</div>
            <div class="p-2 text-sm text-gray-300 text-center">${t}</div>
            <div class="text-xs text-gray-500 text-center pb-2">æ€»è®¡æä¾›äººå£: ${e.length*10}</div>
        `}renderBuildMenu(){this.container.innerHTML='<div class="popover-title">å»ºé€ å»ºç­‘</div>',Object.entries(L).forEach(([e,t])=>{const s=document.createElement("div");s.className="menu-btn build-action-btn",s.dataset.costWood=(t.cost.wood||0).toString(),s.dataset.costStone=(t.cost.stone||0).toString(),s.innerHTML=`
                <span class="btn-icon">${t.icon}</span>
                <div class="btn-info">
                    <span>${t.label}</span>
                    <span class="btn-cost text-xs text-gray-400">${t.desc}</span>
                    <div class="btn-cost mt-1">
                        ${t.cost.wood?t.cost.wood+"æœ¨ ":""}${t.cost.stone?t.cost.stone+"çŸ³":""}
                    </div>
                </div>
            `,s.onclick=()=>{var i;const o=this.game.player;if(o.resources.wood>=(t.cost.wood||0)&&o.resources.stone>=(t.cost.stone||0)){o.resources.wood-=t.cost.wood||0,o.resources.stone-=t.cost.stone||0;const n=`const-${Math.floor(Math.random()*1e5)}`;o.constructions.push({id:n,type:e,ticksLeft:t.time,totalTicks:t.time}),S.showToast(`${t.label} å¼€å§‹å»ºé€ `,"#3b82f6"),(i=document.getElementById("game-wrapper"))==null||i.click()}else S.showToast("èµ„æºä¸è¶³")},this.container.appendChild(s)})}renderBuildingMenu(e){const t=L[e.type],s=this.game.player;this.container.innerHTML=`
            <div class="popover-title">${t.label}</div>
            <div id="popover-status-text" class="text-xs text-center mb-2 font-bold text-gray-500">ç©ºé—²</div>
            <div class="text-xs text-gray-400 text-center mb-2">${t.desc}</div>
        `;const o=e.getMenuOptions(s);o.length===0?this.container.innerHTML+='<div class="text-xs text-gray-500 text-center p-2">æ— å¯ç”¨æ“ä½œ</div>':o.forEach(n=>{const r=document.createElement("div");r.className="menu-btn produce-action-btn",r.dataset.costFood=(n.cost.food||0).toString(),r.dataset.costWood=(n.cost.wood||0).toString(),r.dataset.costGold=(n.cost.gold||0).toString(),r.dataset.costStone=(n.cost.stone||0).toString();let c="";n.cost.food&&(c+=`${n.cost.food}è‚‰ `),n.cost.wood&&(c+=`${n.cost.wood}æœ¨ `),n.cost.gold&&(c+=`${n.cost.gold}é‡‘ `),n.cost.stone&&(c+=`${n.cost.stone}çŸ³ `),r.innerHTML=`
                    <span class="btn-icon">${n.icon}</span>
                    <div class="btn-info">
                        <span>${n.label}</span>
                        <span class="btn-cost">${c}</span>
                    </div>
                `,r.onclick=()=>{s.resources.food>=(n.cost.food||0)&&s.resources.wood>=(n.cost.wood||0)&&s.resources.gold>=(n.cost.gold||0)&&s.resources.stone>=(n.cost.stone||0)?e.enqueue({type:n.id,ticksLeft:n.time,totalTicks:n.time})?(s.resources.food-=n.cost.food||0,s.resources.wood-=n.cost.wood||0,s.resources.gold-=n.cost.gold||0,s.resources.stone-=n.cost.stone||0,this.renderBuildingMenu(e),this.updateStatus(e.id)):S.showToast("é˜Ÿåˆ—å·²æ»¡"):S.showToast("èµ„æºä¸è¶³")},this.container.appendChild(r)});const i=document.createElement("div");i.id="popover-queue-info",i.className="text-xs text-gray-400 text-center mt-1",this.container.appendChild(i)}}class j{constructor(e){this.activePopoverId=null,this.lastTechState="",this.game=e,this.dockRenderer=new P(e),this.popoverRenderer=new z(e),this.setupListeners(),this.setupTooltipListeners()}setupListeners(){["defend","hold","attack"].forEach(t=>{const s=document.getElementById(`btn-stance-${t}`);s&&(s.onclick=()=>{this.game.playerStance=t,this.updateStanceUI()})});const e=t=>{const s=document.getElementById(`add-${t}`),o=document.getElementById(`sub-${t}`);s&&(s.onclick=()=>this.modWork(t,1)),o&&(o.onclick=()=>this.modWork(t,-1))};["food","wood","gold","stone"].forEach(e),document.getElementById("game-wrapper").addEventListener("click",t=>{!t.target.closest(".dock-icon")&&!t.target.closest(".popover-menu")&&this.closePopover()})}setupTooltipListeners(){const e=document.getElementById("gameCanvas");e&&(e.addEventListener("mousemove",t=>this.handleTooltip(t)),e.addEventListener("mouseleave",()=>{const t=document.getElementById("unit-tooltip");t&&(t.style.display="none")}))}handleTooltip(e){if(this.game.gameOver)return;const t=document.getElementById("gameCanvas"),s=t.getBoundingClientRect(),o=e.clientX-s.left,i=e.clientY-s.top,n=t.width,r=t.height;let c=null;const a=[...this.game.player.units,...this.game.enemy.units];for(let h=a.length-1;h>=0;h--){const f=a[h],E=f.pos/100*n,v=f.lane===1?r/2-20:r/2+20;if(Math.abs(o-E)<15&&Math.abs(i-v)<20){c=f;break}}const p=document.getElementById("unit-tooltip");if(c){const h=x[c.type],f=c.owner===k.Player,E=h.damage||0,v=c.damage-E;p.className=f?"":"tt-enemy";let w=`<div class="tt-header">${h.label} (${f?"æˆ‘æ–¹":"æ•Œæ–¹"})</div>`;w+=`<div class="tt-row"><span>â¤ï¸ ç”Ÿå‘½:</span> <span>${Math.ceil(c.hp)}/${c.maxHp}</span></div>`,w+=`<div class="tt-row"><span>ğŸ—¡ï¸ åŸºç¡€æ”»å‡»:</span> <span>${E}</span></div>`,v>0&&(w+=`<div class="tt-row"><span>ğŸ”¥ æ”»å‡»åŠ æˆ:</span> <span class="val-bonus">+${v}</span></div>`),w+=`<div class="tt-row"><span>ğŸ›¡ï¸ è¿‘æˆ˜é˜²å¾¡:</span> <span>${c.def_m}</span></div>`,w+=`<div class="tt-row"><span>ğŸ¯ è¿œç¨‹é˜²å¾¡:</span> <span>${c.def_r}</span></div>`,p.innerHTML=w,p.style.left=e.clientX+15+"px",p.style.top=e.clientY+15+"px",p.style.display="block";return}let d=null;const m=r/2-40,b=r/2+40;if(i>=m&&i<=b){const h=u.BASE_WIDTH/100*n,f=u.PLAYER_BASE_POS/100*n;Math.abs(o-f)<h/2&&(d=this.game.player);const E=u.ENEMY_BASE_POS/100*n;Math.abs(o-E)<h/2&&(d=this.game.enemy)}if(d){const h=d.type===k.Player,f=d.hasTurret?x[g.Spearman].damage*1.5:0;p.className=h?"":"tt-enemy";let E=`<div class="tt-header">${h?"æˆ‘æ–¹":"æ•Œæ–¹"}åŸºåœ°</div>`;E+=`<div class="tt-row"><span>â¤ï¸ ç”Ÿå‘½:</span> <span>${Math.ceil(d.baseHp)}/${u.BASE_HP}</span></div>`,E+='<div class="tt-row"><span>ğŸ›¡ï¸ è¿‘æˆ˜é˜²å¾¡:</span> <span>2</span></div>',E+='<div class="tt-row"><span>ğŸ¯ è¿œç¨‹é˜²å¾¡:</span> <span>2</span></div>',d.hasTurret&&(E+=`<div class="tt-row"><span>âš”ï¸ ç‚®å°ä¼¤å®³:</span> <span>${f}</span></div>`),p.innerHTML=E,p.style.left=e.clientX+15+"px",p.style.top=e.clientY+15+"px",p.style.display="block"}else p.style.display="none"}modWork(e,t){const s=this.game.player;t>0?s.idleWorkers>0&&(s.idleWorkers--,s.workers[e]++):s.workers[e]>0&&(s.workers[e]--,s.idleWorkers++)}update(){var n,r;const e=this.game.player;["food","wood","gold","stone"].forEach(c=>{document.getElementById(`res-stock-${c}`).innerText=Math.floor(e.resources[c]).toString(),document.getElementById(`res-workers-${c}`).innerText=e.workers[c].toString();const a=document.getElementById(`add-${c}`),p=document.getElementById(`sub-${c}`);a&&(e.idleWorkers>0?a.classList.remove("disabled"):a.classList.add("disabled")),p&&(e.workers[c]>0?p.classList.remove("disabled"):p.classList.add("disabled"))});const t=document.getElementById("disp-pop"),s=e.currentPop;t.innerText=`${s}/${e.popCap}`,s>=e.popCap?(t.style.color="#ef4444",t.classList.add("warning")):s>=e.popCap*.8?(t.style.color="#eab308",t.classList.remove("warning")):(t.style.color="#e5e5e5",t.classList.remove("warning")),document.getElementById("disp-idle").innerText=e.idleWorkers.toString(),e.idleWorkers>0?(n=document.getElementById("disp-idle"))==null||n.classList.add("warning"):(r=document.getElementById("disp-idle"))==null||r.classList.remove("warning"),document.getElementById("p-base-hp").style.width=e.baseHp/2e3*100+"%",document.getElementById("e-base-hp").style.width=this.game.enemy.baseHp/2e3*100+"%";const o=document.getElementById("p-base"),i=document.getElementById("e-base");if(o&&(e.hasTurret?o.classList.add("has-turret"):o.classList.remove("has-turret")),i&&(this.game.enemy.hasTurret?i.classList.add("has-turret"):i.classList.remove("has-turret")),this.dockRenderer.render(this.activePopoverId,(c,a)=>{this.handleDockClick(c,a)}),this.activePopoverId){const c=JSON.stringify(e.techLevels);this.lastTechState!==c&&(this.lastTechState=c,this.activePopoverId!=="build_menu"&&!this.activePopoverId.startsWith("group")&&this.popoverRenderer.render(this.activePopoverId,this.activePopoverId==="build_menu"?"dock-btn-build":`dock-item-${this.activePopoverId}`)),this.popoverRenderer.updateStatus(this.activePopoverId)}else this.lastTechState=JSON.stringify(e.techLevels)}handleDockClick(e,t){if(t.type==="construction")return;if(this.activePopoverId===e){this.closePopover();return}this.activePopoverId=e;const s=e==="build_menu"?"dock-btn-build":`dock-item-${e}`;this.popoverRenderer.render(e,s)}closePopover(){this.activePopoverId=null,this.popoverRenderer.hide()}updateStanceUI(){["defend","hold","attack"].forEach(e=>{const t=document.getElementById(`btn-stance-${e}`);t.className=`tactic-btn ${this.game.playerStance===e?"active":""}`})}}const R=class R{constructor(){this.tickCount=0,this.gameOver=!1,this.isInstantBuild=!1,this.turretShots=[],this.worldWidth=0,this.baseWidthPct=6,this.playerStance="attack",this.enemyStance="attack",this.player=new O(k.Player),this.enemy=new O(k.Enemy),this.player.buildings.push(new B("p-tc",k.Player)),this.enemy.buildings.push(new B("e-tc",k.Enemy)),this.renderer=new N(this),this.loop=new q(this),this.combatSystem=new D(this),this.economySystem=new V(this),this.aiSystem=new K(this),this.uiManager=new j(this),this.loop.start(),window.game=this,setInterval(()=>this.debugAI(),3e3)}static nextId(){return++this.entityIdCounter}update(){this.gameOver||(this.turretShots=[],this.tickCount++,this.economySystem.update(),this.aiSystem.update(),this.combatSystem.update(),this.uiManager.update(),this.renderer.draw())}endGame(e){this.gameOver=!0,this.loop.stop();const t=document.getElementById("game-over");t.style.display="flex",document.getElementById("end-title").innerText=e?"VICTORY":"DEFEAT"}debugAI(){var t;if(this.gameOver)return;const e=this.enemy;console.groupCollapsed(`ğŸ¤– AI çŠ¶æ€ç›‘æ§ (Tick: ${this.tickCount})`),console.log(`ğŸ’° èµ„æº: F${Math.floor(e.resources.food)} W${Math.floor(e.resources.wood)} G${Math.floor(e.resources.gold)} S${Math.floor(e.resources.stone)}`),console.log(`ğŸ‘· äººå£: ${e.currentPop}/${e.popCap} (é—²ç½®: ${e.idleWorkers})`),console.log(`âš”ï¸ å†›é˜Ÿ: ${e.armyCount}`),console.log("ğŸ—ï¸ å»ºç­‘:",e.buildings.map(s=>`${s.type}(${s.queue.length})`)),console.log(`âš”ï¸ æˆ˜æœ¯å§¿æ€: ${this.enemyStance}`),console.log("âš”ï¸ ç§‘ç ”çŠ¶æ€: è¿‘æˆ˜æ”»å‡» / è¿‘æˆ˜é˜²å¾¡ / è¿œç¨‹æ”»å‡» / è¿œç¨‹é˜²å¾¡"),console.log(`âš”ï¸ ${e.techLevels.atk_m} / ${e.techLevels.def_m} / ${e.techLevels.atk_r}, ${e.techLevels.def_r}`),console.log(`âš”ï¸ é“åŒ é“ºå¿™ç¢Œæƒ…å†µ: ${(t=e.buildings.find(s=>s.type===y.Blacksmith))==null?void 0:t.queue.length}`),console.groupEnd()}};R.entityIdCounter=0;let C=R;document.addEventListener("DOMContentLoaded",()=>{const l=new C;window.show_me_the_money=()=>{l&&l.player&&(l.player.resources={food:99999,wood:99999,gold:99999,stone:99999},console.log("ğŸ’° Resources granted: 99999 [Food, Wood, Gold, Stone]"),l.uiManager.update())},window.operation_cwal=()=>{l&&(l.isInstantBuild=!l.isInstantBuild,console.log(`âš¡ Operation CWAL: ${l.isInstantBuild?"ENABLED (Player Only)":"DISABLED"}`))},console.log("Minimalist Empire Engine Started!"),console.log("Cheats:"),console.log("  - show_me_the_money(): Get resources"),console.log("  - operation_cwal(): Instant build/research")});
